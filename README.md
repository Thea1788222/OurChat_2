# OurChat2.0

## 零、测试方式

基础账号：
1、Ian@123.com
2、Alice@123.com
3、Phil@123.com
4、Fiona@123.com

密码均为123456

## 一、项目总体定位与技术约束

这是一个**基于原生 Java Web 技术的聊天室练手项目**，目标是：

* 在不依赖任何重量级框架的前提下
* 使用 Servlet + JSP + MVC 分层
* 通过相对“底层”的方式，完整实现：用户会话管理，在线状态感知，实时/准实时聊天，页面动态刷新

### 技术环境

* **JDK**：17

* **Servlet 容器**：Tomcat 11

* **后端技术限制**：

    * 原生 Servlet
    * 计划使用 WebSocket
    * （本项目主要基于 Servlet 的 HTTP 请求/响应模型。但为了在不引入额外中间件的前提下，更贴合聊天系统的实时特性，我计划采用 Servlet 容器原生支持的 WebSocket 技术。WebSocket 初始仍基于 HTTP 建立连接，但随后提供更高效的双向通信能力。）

* **前端技术限制**：

    * JSP
    * JSTL
    * EL
    * 原生 JavaScript
    * 原生 CSS
    * 不使用任何前端框架或第三方 JS 库
    * 前端不允许出现java代码

---

## 二、数据存储与生命周期

### 存储方式

* 持久化数据（数据库存储）

    * 用户基本信息（用户id、用户昵称、用户邮箱、加密密码）
    * 聊天消息记录（聊天消息记录id、发送人id、发送人昵称、发送内容、全部可见还是某个私聊用户、发送时间）
    * 系统消息记录（xxx上线或xxx下线，系统消息记录id、上下线用户id、上下线用户昵称、上线还是下线）

* 运行态数据（内存）

    * 在线用户列表
    * 用户在线/离线状态
    * 用户 Session / WebSocket 连接映射
    * 在线人数（运行态派生数据，由在线用户集合实时计算，不做任何持久化）

### 重启行为

* **服务器重启后**：

    * 用户数据保留
    * 聊天消息记录保留
    * 系统消息记录保留
    * 在线人数归零（因为在线用户集合被清空）  ← 修改行 43

---

## 三、用户管理功能需求

### 1. 用户基本信息

系统需维护以下用户信息：

* 自动生成的用户 ID
* 昵称（可重复）
* 邮箱（不可重复，用户可以根据这个登录）
* 密码（以**简单加密形式**存储，不使用明文）
* 在线 / 离线状态（运行态信息，不做持久化）

### 2. 登录与登出规则

* 登录通过 Servlet + HttpSession 实现
* 未登录用户

    * 通过过滤器（Filter）校验
    * 禁止直接访问聊天室 JSP
* 不允许同一用户多端同时登录

    * 只允许一个用户同时存在一个有效 Session / WebSocket
    * 登录时若检测到用户已在线：使旧会话失效
* 支持两种下线方式：

    1. 用户主动点击“退出登录”：调用 Servlet 清理 Session 与在线状态
    2. 用户直接关闭浏览器页面：Session 超时 + WebSocket onClose 回调，允许一定的延时

### 3. 用户状态感知

* 系统需感知并区分：

    * 在线用户
    * 离线用户
* 在线状态不需要跨服务器重启保留

---

## 四、聊天消息功能

### 1. 聊天消息内容结构

每一条聊天消息需包含：

* 聊天消息id

* 发送人id

* 发送人昵称

* 消息内容（仅文本）（可以限制最大字数简化数据结构）

* 可见对象：

    * 全体用户
    * 某一个指定用户id、昵称（私聊）

* 发送时间

### 3. 私聊规则

* 仅实现 **单选私聊**
* 私聊对象：

    * 可以是在线用户
    * 也可以是离线用户
* 离线用户不会实时收到消息，但消息会被存储
* 可见性判断：由服务器在推送或返回消息时进行过滤
* 离线用户：不实时接收但数据库中保留消息记录

### 4. 历史消息

* 新上线用户进入聊天室后：

    * 可以看到**全部历史聊天消息**
* 不要求分页或截断
* 假设消息总量在可控范围内

---

## 五、系统消息功能

### 1. 系统消息内容结构

每一条系统消息需包含：

* 系统消息id
* 上下线用户id
* 上下线用户昵称
* 上下线时间

### 2. 显示规则

* 前端页面仅显示最新一条上下线消息，并能自动更新刷新，但历史系统消息仍会被持久化保存

---

## 六、实时通信与页面更新机制

### WebSocket 的角色

* 聊天消息发送与接收
* 系统消息（上线 / 下线）推送
* 用户列表与在线人数的动态刷新

### HTTP 的角色

* 登录
* 登出
* 页面跳转
* 初次进入聊天室时：

    * 加载历史消息
    * 加载用户列表基础信息

---

## 七、页面结构与交互说明

### 页面组成

仅包含两个主要页面：

1. **登录页**
2. **聊天室页**

不设独立的“个人信息页”。

---

## 八、聊天室页面详细布局与行为

### 1. 顶栏（Header）

* 使用 JSP + EL 显示当前登录用户：

    * 昵称
    * 用户 ID
* “退出登录”按钮：

    * 触发 HTTP 请求
    * 清理Session 并关闭 WebSocket

---

### 2. 主体区域布局

页面主体分为左右两部分：

---

### （一）左侧：聊天窗口

#### 上半部分：聊天内容区

* 初次进入：

    * 通过 Servlet 查询数据库
    * 返回全部历史消息
* 后续更新：

    * 通过 WebSocket 实时追加
* 前端：

    * JS 动态追加 DOM
    * 自动滚动到底部
* 每条消息显示：

    * 发送人昵称
    * 消息内容（支持多行显示）
    * 可见对象
    * 发送时间

#### 昵称颜色规则（全局一致）

* 当前登录用户（“我”）：

    * 始终显示为 **红色**
    * 不论是发送人还是接收人
    * 前端通过用户id判断（JSTL）
* 其他用户：

    * 在线：绿色
    * 离线：灰色
    * 该规则在聊天区与用户列表中保持一致

---

#### 下半部分：消息输入区

* 包含以下组件：

    1. **可见对象选择下拉框**

        * 全员可见
        * 某一个指定用户
        * 显示用户昵称
        * 在线用户昵称为绿色
        * 离线用户昵称为灰色
        * 数据来源于用户列表
        * 单选（全体 / 某用户）
    2. **消息内容输入框**

        * 支持多行输入，多行 textarea
        * 仅允许发送文本
        * 限制最大字数以简化存储结构
    3. **发送按钮**

        * 通过 WebSocket 发送消息数据

---

### （二）右侧：用户列表窗口

按从上到下顺序包含四个区域：

1. **在线人数显示**

    * 显示当前在线用户数量
    * **由 OnlineUserService 计算实时人数，不持久化**  ← 修改行 205

2. **在线用户列表**

    * 可上下滚动
    * 显示在线用户昵称
    * 昵称为绿色

3. **离线用户列表**

    * 可上下滚动
    * 显示离线用户昵称
    * 昵称为灰色

4. **动态状态提示区**

    * 仅显示一行文本
    * 内容为：

        * “xxx 上线”
        * 或 “xxx 离线”
    * 内容由 WebSocket 推送
    * 不可滚动

---

## 九、项目目录与构建（建议）

OurChat2.0/
├── pom.xml
├── README.md
├── docs/
│
└── src/
└── main/
├── java/
│   └── com/
│       └── example/ourchat2/
│           ├── controller/
│           │   ├── LoginServlet.java
│           │   │── LogoutServlet.java
│           │   │── ChatPageServlet.java
│           │   |── UserListServlet.java  //提供用户列表数据（JSON）
│           │
│           ├── websocket/
│           │   └── ChatWebSocket.java
│           │
│           ├── service/
│           │   ├── UserService.java
│           │   ├── ChatMessageService.java
│           │   ├── OnlineUserService.java  //运行态在线用户管理（核心） ← 核心修改点
│           │   └── SystemMessageService.java
│           │
│           ├── dao/
│           │   ├── UserDao.java
│           │   ├── UserDaoImpl.java
│           │   ├── ChatMessageDaoImpl.java
│           │   ├── ChatMessageDao.java
│           │   ├── SystemMessageDaoImpl.java
│           │   └── SystemMessageDao.java
│           │
│           ├── model/
│           │   ├── User.java
│           │   ├── ChatMessage.java
│           │   └── SystemMessage.java
│           │   └── WebSocketMessageDTO.java
│           │
│           ├── listener/
│           │   ├── AppInitListener.java
│           │   ├── SessionListener.java
│           │   └── WebSocketSessionListener.java
│           │
│           ├── filter/
│           │   └── LoginFilter.java
│           │
│           └── util/
│               ├── PasswordUtil.java
│               ├── JsonUtil.java
│               └── TimeUtil.java
│
├── resources/
│   ├── sql
│   │   └── schema.sql
│   └── db.properties
│
└── webapp/
├── jsp/
│   ├── login.jsp
│   └── chat.jsp
│
├── static/
│   ├── css/
│   │   └── chat.css
│   └── js/
│       └── chat.js
│
└── WEB-INF/
└── web.xml
